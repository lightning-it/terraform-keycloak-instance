name: Terraform Module CI

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  pull_request:

permissions:
  contents: read

jobs:
  terraform-module:
    name: Terraform module checks (Terraform ${{ matrix.terraform_version }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        terraform_version: ["1.6.6", "1.9.0"]

    defaults:
      run:
        shell: bash

    steps:
      # 1) Checkout
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Install Terraform CLI
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false
          terraform_version: ${{ matrix.terraform_version }}

      # 3) Format check in the module root
      - name: Terraform fmt (check)
        run: terraform fmt -check -recursive

      # 4) Init without backend (we are testing a module, no state)
      - name: Terraform init (module root)
        run: terraform init -backend=false

      # 5) Validate module configuration
      - name: Terraform validate (module root)
        run: terraform validate

      # 6) Validate test fixtures (smoke/advanced/empty)
      - name: Terraform validate (test fixtures)
        run: |
          for dir in tests/keycloak-smoke tests/keycloak-advanced tests/keycloak-empty; do
            terraform -chdir="$dir" init -backend=false
            terraform -chdir="$dir" validate
          done

      # 7) TFLint across the repo
      - name: TFLint (via wunder-devtools-ee)
        run: bash scripts/wunder-devtools-ee.sh tflint --recursive
